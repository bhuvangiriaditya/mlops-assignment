name: MLOps CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      HF_REPO: adityabhuvangiri/cats-dogs-classifier
      MODEL_VERSION: v${{ github.run_number }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install .

    - name: Load Kaggle credentials
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_TOKEN: ${{ secrets.KAGGLE_TOKEN }}
      run: |
        cat > kaggle.json <<EOF
        {
          "username": "${KAGGLE_USERNAME}",
          "key": "${KAGGLE_TOKEN}"
        }
        EOF
        chmod 755 kaggle.json

    - name: Load Dataset
      run: |
          bash scripts/setup_data.sh

    - name: Run unit tests
      run: |
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        pytest tests \
          --junitxml=test-results.xml \
          --cov=src \
          --cov-report=xml \
          --cov-report=html

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts
        path: |
          test-results.xml
          htmlcov/
          coverage.xml

    - name: Run training
      run: |
        python train.py

    - name: Push model to Hugging Face
      run: |
        python - << 'EOF'
        import os
        from huggingface_hub import HfApi

        api = HfApi(token=os.environ["HF_TOKEN"])

        repo_id = os.environ["HF_REPO"]
        version = os.environ["MODEL_VERSION"]

        api.upload_file(
            path_or_fileobj="model.pth",                 # make sure this exists
            path_in_repo=f"{version}/best_model.pth",    # versioned on HF
            repo_id=repo_id,
            repo_type="model",
            commit_message=f"Upload model version {version}",
        )

        print(f"âœ… Model pushed to {repo_id} as {version}")
        EOF

    - name: Docker Hub Login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      run: |
        docker build \
          -t aditya3298/mlops-2:${{ env.MODEL_VERSION }} \
          -t aditya3298/mlops-2:latest \
          .

    - name: Push Docker image
      run: |
        docker push aditya3298/mlops:${{ env.MODEL_VERSION }}
        docker push aditya3298/mlops:latest