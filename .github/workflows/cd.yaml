name: MLOps CD

on:
  workflow_run:
    workflows: ["MLOps CI"]
    types: [completed]

env:
  IMAGE_NAME: aditya3298/mlops-2

jobs:
  deploy-k8s:
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Validate kubeconfig secret
        run: |
          if [ -z "${{ secrets.KUBE_CONFIG_DATA }}" ]; then
            echo "KUBE_CONFIG_DATA is empty or not configured."
            exit 1
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p "${HOME}/.kube"
          printf '%s' "${{ secrets.KUBE_CONFIG_DATA }}" > "${HOME}/.kube/config"

      - name: Apply manifests
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Update deployment image
        run: |
          kubectl set image deployment/cats-dogs-classifier-deploy \
            classifier-container=${{ env.IMAGE_NAME }}:latest
          kubectl rollout status deployment/cats-dogs-classifier-deploy --timeout=180s

      - name: Post-deploy smoke test
        run: |
          set -o pipefail
          kubectl port-forward svc/cats-dogs-classifier-svc 8000:80 >/tmp/port-forward.log 2>&1 &
          echo $! > /tmp/port-forward.pid
          sleep 5
          chmod +x scripts/smoke_test.sh
          ./scripts/smoke_test.sh 2>&1 | tee post-deploy-smoke-report.txt

      - name: Capture deployment diagnostics
        if: always()
        run: |
          cp /tmp/port-forward.log port-forward.log 2>/dev/null || echo "No port-forward log found." > port-forward.log
          kubectl get pods -o wide > k8s-pods.txt 2>&1 || true
          kubectl get svc > k8s-services.txt 2>&1 || true

      - name: Upload CD reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cd-reports-${{ github.run_id }}
          if-no-files-found: warn
          path: |
            post-deploy-smoke-report.txt
            port-forward.log
            k8s-pods.txt
            k8s-services.txt

      - name: Cleanup port-forward
        if: always()
        run: |
          if [ -f /tmp/port-forward.pid ]; then
            kill "$(cat /tmp/port-forward.pid)" || true
          fi
